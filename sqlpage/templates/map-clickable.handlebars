<div id="{{#if id}}{{id}}{{else}}map{{/if}}"
  style="height: {{#if height}}{{height}}{{else}}600{{/if}}px;">
</div>

<div style="margin:.5rem 0;">
  <button style="background-color: #3C2946; border: none; margin-right: auto; margin-left: auto; display: block; padding: 10px; color: white; font-family: 'Inter' sans-serif; font-weight: 500; border-radius: 10px; margin-bottom: -35px;" id="reset-map-btn" type="button">Reset Map</button>
</div>

<script nonce="{{@csp_nonce}}">
(function boot() {
  const el_id = "{{#if id}}{{id}}{{else}}map{{/if}}";
  const el = document.getElementById(el_id);
  if (!el) return;
  if (typeof window.L === 'undefined') return setTimeout(boot, 30);

  // Initial view (override via index.sql)
  const init_lat  = {{#if latitude}}{{latitude}}{{else}}39.8283{{/if}};
  const init_lon  = {{#if longitude}}{{longitude}}{{else}}-98.5795{{/if}};
  const init_zoom = {{#if zoom}}{{zoom}}{{else}}4{{/if}};
  const map = L.map(el).setView([init_lat, init_lon], init_zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: {{#if max_zoom}}{{max_zoom}}{{else}}19{{/if}}
  }).addTo(map);

  // Delete ONLY when the popup's × is clicked.
  // If marker_id is null, we remove the marker visually and flag it as deleted;
  // when the DB id comes back later, we will sync-delete it from the DB.
  function wire_delete_on_popup_x(marker, marker_id) {
    marker.on('popupopen', (e) => {
      const popup_el = (e.popup.getElement && e.popup.getElement()) || e.popup._container;
      const close_button = popup_el && popup_el.querySelector('.leaflet-popup-close-button');
      if (!close_button) return;

      const on_close_click = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

        marker.remove();                 // remove from map immediately
        marker._deleted = true;          // mark as removed (used for pre-save deletes)

        if (marker_id != null) {
          // We know the DB row: delete it now.
          fetch('delete_marker.sql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ id: marker_id }).toString()
          });
        }
      };

      // capture:true so we intercept before Leaflet's own handler
      close_button.addEventListener('click', on_close_click, { once: true, capture: true });
    });
  }

  // Add a saved marker from a GeoJSON Feature (row ID or properties.id)
  function add_saved_marker_from_feature(f, row_id) {
    if (!f || f.type !== "Feature" || !f.geometry || f.geometry.type !== "Point") return;
    const coords = f.geometry.coordinates; // [lon, lat]
    if (!Array.isArray(coords) || coords.length < 2) return;

    const m = L.marker([coords[1], coords[0]]).addTo(map);

    // Show your imported popup HTML (loaded below), with the default × button
    m.bindPopup('<div class="popup-body">Loading…</div>', {
      closeButton: true,
      closeOnClick: false,
      autoClose: false
    });

    const marker_id = (row_id != null)
      ? row_id
      : (f.properties && typeof f.properties.id !== 'undefined' ? f.properties.id : null);

    if (marker_id != null) {
      // Load your popup HTML exactly as returned by marker_popup.sql
      fetch('marker_popup.sql?marker_id=' + encodeURIComponent(marker_id))
        .then(r => r.text())
        .then(html => { const p = m.getPopup(); if (p) p.setContent(html); })
        .catch(() => { const p = m.getPopup(); if (p) p.setContent('<strong>Marker</strong>'); });

      // Enable delete via the popup × (will also delete from DB)
      wire_delete_on_popup_x(m, marker_id);
    } else {
      // No id: still allow visual delete via × (DB sync handled when id is known)
      wire_delete_on_popup_x(m, null);
    }

    return m;
  }

  // Render existing saved pins (index.sql should SELECT id, geojson FROM markers;)
  try {
    {{#each_row}}
      {{#if geojson}}
        (function() {
          try {
            const feature = {{{geojson}}};
            const row_id = {{#if id}}{{id}}{{else}}null{{/if}};
            add_saved_marker_from_feature(feature, row_id);
          } catch (e) { console.error('Bad GeoJSON row', e); }
        })();
      {{/if}}
    {{/each_row}}
  } catch (e) {
    console.error('Rendering existing markers failed', e);
  }

  // Map click: drop a pin, open popup immediately, save, then wire delete & load popup HTML
  map.on('click', (e) => {
    const m = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

    // Open a popup right away
    m.bindPopup('<div class="popup-body">Saving…</div>', {
      closeButton: true, closeOnClick: false, autoClose: false
    }).openPopup();

    // Allow delete immediately even before DB id is known
    wire_delete_on_popup_x(m, null);

    // Save to DB and get the NEW id back
    fetch('add_marker.sql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        latitude:  e.latlng.lat,
        longitude: e.latlng.lng,
        title: ''
      }).toString()
    })
    .then(r => r.text())
    .then(t => {
      const match = t && t.match(/(\d+)/);
      const new_id = match ? parseInt(match[1], 10) : null;

      if (m._deleted) {
        // User already clicked × before the insert returned → sync delete the DB row
        if (new_id != null) {
          fetch('delete_marker.sql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ id: new_id }).toString()
          });
        }
        return; // marker already gone from UI
      }

      // Now we know the id: re-wire delete to also remove from DB
      wire_delete_on_popup_x(m, new_id);

      // Load your popup HTML
      if (new_id != null) {
        return fetch('marker_popup.sql?marker_id=' + encodeURIComponent(new_id))
          .then(r2 => r2.text())
          .then(html => { const p = m.getPopup(); if (p) p.setContent(html); })
          .catch(() => { const p = m.getPopup(); if (p) p.setContent('<strong>Marker</strong>'); });
      } else {
        const p = m.getPopup();
        if (p) p.setContent('<strong>Marker saved</strong>');
      }
    })
    .catch(() => {
      const p = m.getPopup();
      if (p) p.setContent('<strong>Save failed</strong>');
    });
  });

  // Reset Map button: delete ALL markers, then refresh
  document.getElementById('reset-map-btn')?.addEventListener('click', () => {
    fetch('clear_markers.sql', { method: 'POST' })
      .then(() => location.reload())
      .catch(() => location.reload()); // still refresh UI even if delete fails
  });
})();
</script>