<div id="{{#if id}}{{id}}{{else}}map{{/if}}"
  style="height: {{#if height}}{{height}}{{else}}600{{/if}}px;">
</div>

<div style="margin:.5rem 0;">
  <button id="reset-map-btn" type="button">Reset Map</button>
</div>

<script nonce="{{@csp_nonce}}">
(function boot() {
  const el_id = "{{#if id}}{{id}}{{else}}map{{/if}}";
  const el = document.getElementById(el_id);
  if (!el) return;
  if (typeof window.L === 'undefined') return setTimeout(boot, 30);

  // Initial view (override via index.sql)
  const init_lat  = {{#if latitude}}{{latitude}}{{else}}39.8283{{/if}};
  const init_lon  = {{#if longitude}}{{longitude}}{{else}}-98.5795{{/if}};
  const init_zoom = {{#if zoom}}{{zoom}}{{else}}4{{/if}};
  const map = L.map(el).setView([init_lat, init_lon], init_zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: {{#if max_zoom}}{{max_zoom}}{{else}}19{{/if}}
  }).addTo(map);

  // Attach delete-on-X
  function wire_delete_on_popup_x(marker, marker_id) {
    if (marker_id == null) return; // only for saved markers
    marker.on('popupopen', (e) => {
      const popup_el = (e.popup.getElement && e.popup.getElement()) || e.popup._container;
      console.log('test');
      const close_button = popup_el && popup_el.querySelector('.leaflet-popup-close-button');
      if (!close_button) return;

      const on_close_click = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

        marker.remove();
        console.log('Marker deleted: ' + marker_id);

        fetch('delete_marker.sql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ id: marker_id }).toString()
        });
      };

      close_button.addEventListener('click', on_close_click, { once: true, capture: true });
    });
  }

  // Add a saved marker from a GeoJSON Feature (row ID or properties.id)
  function add_saved_marker_from_feature(f, row_id) {
    if (!f || f.type !== "Feature" || !f.geometry || f.geometry.type !== "Point") return;
    const coords = f.geometry.coordinates; // [lon, lat]
    if (!Array.isArray(coords) || coords.length < 2) return;

    const m = L.marker([coords[1], coords[0]]).addTo(map);

    m.bindPopup('<div class="popup-body">Loadingâ€¦</div>', {
      closeButton: true,
      closeOnClick: false,
      autoClose: false
    });

    const marker_id = (row_id != null) ? row_id
                   : (f.properties && typeof f.properties.id !== 'undefined' ? f.properties.id : null);

    if (marker_id != null) {
      fetch('marker_popup.sql?marker_id=' + encodeURIComponent(marker_id))
        .then(r => r.text())
        .then(html => { const p = m.getPopup(); if (p) p.setContent(html); })
        .catch(() => { const p = m.getPopup(); if (p) p.setContent('<strong>Marker</strong>'); });

      wire_delete_on_popup_x(m, marker_id);
    }

    return m;
  }

  // Render existing saved pins (index.sql: SELECT id, geojson FROM markers;)
  try {
    {{#each_row}}
      {{#if geojson}}
        (function() {
          try {
            const feature = {{{geojson}}};
            const row_id = {{#if id}}{{id}}{{else}}null{{/if}};
            add_saved_marker_from_feature(feature, row_id);
          } catch (e) { console.error('Bad GeoJSON row', e); }
        })();
      {{/if}}
    {{/each_row}}
  } catch (e) {
    console.error('Rendering existing markers failed', e);
  }

  // Map click: drop a pin, open its popup immediately, and save (NO page reload)
  map.on('click', (e) => {
    const m = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

    m.bindPopup('<strong>Saved pin</strong>', {
      closeButton: true,
      closeOnClick: false,
      autoClose: false
    }).openPopup();

    fetch('add_marker.sql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        latitude:  e.latlng.lat,
        longitude: e.latlng.lng,
        title: ''
      }).toString()
    });
  });

  // Reset button: the ONLY place we refresh the page
  document.getElementById('reset-map-btn')?.addEventListener('click', () => {
    location.reload();
  });
})();
</script>